import asyncio
import os
from aiortc import RTCPeerConnection, RTCSessionDescription
from aiortc.contrib.media import MediaPlayer

def create_player(file_path):
    if os.path.exists(file_path):
        return MediaPlayer(file_path)
    return None

async def run(pc, player, audio_path, video_path):
    @pc.on("iceconnectionstatechange")
    async def on_iceconnectionstatechange():
        print(f"ICE connection state is {pc.iceConnectionState}")
        if pc.iceConnectionState == "failed":
            await pc.close()

    # Add audio/video tracks if files are present
    if os.path.exists(video_path):
        video_player = create_player(video_path)
        if video_player:
            pc.addTrack(video_player.video)

    if os.path.exists(audio_path):
        audio_player = create_player(audio_path)
        if audio_player:
            pc.addTrack(audio_player.audio)

    # Exchange offer/answer

    sdp_offer = "eyJ0eXBlIjoib2ZmZXIiLCJzZHAiOiJ2PTBcclxubz0tIDgyNTM3MDM2MDQyNDgwMzg5ODkgMiBJTiBJUDQgMTI3LjAuMC4xXHJcbnM9LVxyXG50PTAgMFxyXG5hPWdyb3VwOkJVTkRMRSAwIDFcclxuYT1leHRtYXAtYWxsb3ctbWl4ZWRcclxuYT1tc2lkLXNlbWFudGljOiBXTVNcclxubT12aWRlbyA3MzI2IFVEUC9UTFMvUlRQL1NBVlBGIDk2IDk3IDEwMiAxMDMgMTA0IDEwNSAxMDYgMTA3IDEwOCAxMDkgMTI3IDEyNSAzOSA0MCA0NSA0NiA5OCA5OSAxMDAgMTAxIDExMiAxMTMgMTE2IDExNyAxMThcclxuYz1JTiBJUDQgMTk0Ljc4LjE0Ljc0XHJcbmE9cnRjcDo5IElOIElQNCAwLjAuMC4wXHJcbmE9Y2FuZGlkYXRlOjQ0NjI5MTc3MSAxIHVkcCAyMTEzOTM3MTUxIDEwNzA2NDg5LTM5ZGYtNDEzYi04NzM3LTBlMTk3Y2E2NjUzMi5sb2NhbCA1MTc5NSB0eXAgaG9zdCBnZW5lcmF0aW9uIDAgbmV0d29yay1jb3N0IDk5OVxyXG5hPWNhbmRpZGF0ZToxMzg0Mzk2MTc0IDEgdWRwIDE2Nzc3Mjk1MzUgMTk0Ljc4LjE0Ljc0IDczMjYgdHlwIHNyZmx4IHJhZGRyIDAuMC4wLjAgcnBvcnQgMCBnZW5lcmF0aW9uIDAgbmV0d29yay1jb3N0IDk5OVxyXG5hPWljZS11ZnJhZzowTVYxXHJcbmE9aWNlLXB3ZDoyc1F3NlF0UGZJSGRRMHl5ZlpRTVBjelNcclxuYT1pY2Utb3B0aW9uczp0cmlja2xlXHJcbmE9ZmluZ2VycHJpbnQ6c2hhLTI1NiA5RDpFNDpCQTo2RDpCQzo0NjozQjpDMDpCNjpEQjo4MjpDQjoyMjozRjpGQTo2MTpCNTpCOTowQzo3MTpFMzo4ODo2RDo0MTowQTozMDpGNjpBRDoyNTo5OTo1MDo5OVxyXG5hPXNldHVwOmFjdHBhc3NcclxuYT1taWQ6MFxyXG5hPWV4dG1hcDoxIHVybjppZXRmOnBhcmFtczpydHAtaGRyZXh0OnRvZmZzZXRcclxuYT1leHRtYXA6MiBodHRwOi8vd3d3LndlYnJ0Yy5vcmcvZXhwZXJpbWVudHMvcnRwLWhkcmV4dC9hYnMtc2VuZC10aW1lXHJcbmE9ZXh0bWFwOjMgdXJuOjNncHA6dmlkZW8tb3JpZW50YXRpb25cclxuYT1leHRtYXA6NCBodHRwOi8vd3d3LmlldGYub3JnL2lkL2RyYWZ0LWhvbG1lci1ybWNhdC10cmFuc3BvcnQtd2lkZS1jYy1leHRlbnNpb25zLTAxXHJcbmE9ZXh0bWFwOjUgaHR0cDovL3d3dy53ZWJydGMub3JnL2V4cGVyaW1lbnRzL3J0cC1oZHJleHQvcGxheW91dC1kZWxheVxyXG5hPWV4dG1hcDo2IGh0dHA6Ly93d3cud2VicnRjLm9yZy9leHBlcmltZW50cy9ydHAtaGRyZXh0L3ZpZGVvLWNvbnRlbnQtdHlwZVxyXG5hPWV4dG1hcDo3IGh0dHA6Ly93d3cud2VicnRjLm9yZy9leHBlcmltZW50cy9ydHAtaGRyZXh0L3ZpZGVvLXRpbWluZ1xyXG5hPWV4dG1hcDo4IGh0dHA6Ly93d3cud2VicnRjLm9yZy9leHBlcmltZW50cy9ydHAtaGRyZXh0L2NvbG9yLXNwYWNlXHJcbmE9ZXh0bWFwOjkgdXJuOmlldGY6cGFyYW1zOnJ0cC1oZHJleHQ6c2RlczptaWRcclxuYT1leHRtYXA6MTAgdXJuOmlldGY6cGFyYW1zOnJ0cC1oZHJleHQ6c2RlczpydHAtc3RyZWFtLWlkXHJcbmE9ZXh0bWFwOjExIHVybjppZXRmOnBhcmFtczpydHAtaGRyZXh0OnNkZXM6cmVwYWlyZWQtcnRwLXN0cmVhbS1pZFxyXG5hPXNlbmRyZWN2XHJcbmE9bXNpZDotIGY2ZmRkMDUwLWZhZWEtNGIwZS1iNzU4LTIzNWEwMjk5YzNkOFxyXG5hPXJ0Y3AtbXV4XHJcbmE9cnRjcC1yc2l6ZVxyXG5hPXJ0cG1hcDo5NiBWUDgvOTAwMDBcclxuYT1ydGNwLWZiOjk2IGdvb2ctcmVtYlxyXG5hPXJ0Y3AtZmI6OTYgdHJhbnNwb3J0LWNjXHJcbmE9cnRjcC1mYjo5NiBjY20gZmlyXHJcbmE9cnRjcC1mYjo5NiBuYWNrXHJcbmE9cnRjcC1mYjo5NiBuYWNrIHBsaVxyXG5hPXJ0cG1hcDo5NyBydHgvOTAwMDBcclxuYT1mbXRwOjk3IGFwdD05NlxyXG5hPXJ0cG1hcDoxMDIgSDI2NC85MDAwMFxyXG5hPXJ0Y3AtZmI6MTAyIGdvb2ctcmVtYlxyXG5hPXJ0Y3AtZmI6MTAyIHRyYW5zcG9ydC1jY1xyXG5hPXJ0Y3AtZmI6MTAyIGNjbSBmaXJcclxuYT1ydGNwLWZiOjEwMiBuYWNrXHJcbmE9cnRjcC1mYjoxMDIgbmFjayBwbGlcclxuYT1mbXRwOjEwMiBsZXZlbC1hc3ltbWV0cnktYWxsb3dlZD0xO3BhY2tldGl6YXRpb24tbW9kZT0xO3Byb2ZpbGUtbGV2ZWwtaWQ9NDIwMDFmXHJcbmE9cnRwbWFwOjEwMyBydHgvOTAwMDBcclxuYT1mbXRwOjEwMyBhcHQ9MTAyXHJcbmE9cnRwbWFwOjEwNCBIMjY0LzkwMDAwXHJcbmE9cnRjcC1mYjoxMDQgZ29vZy1yZW1iXHJcbmE9cnRjcC1mYjoxMDQgdHJhbnNwb3J0LWNjXHJcbmE9cnRjcC1mYjoxMDQgY2NtIGZpclxyXG5hPXJ0Y3AtZmI6MTA0IG5hY2tcclxuYT1ydGNwLWZiOjEwNCBuYWNrIHBsaVxyXG5hPWZtdHA6MTA0IGxldmVsLWFzeW1tZXRyeS1hbGxvd2VkPTE7cGFja2V0aXphdGlvbi1tb2RlPTA7cHJvZmlsZS1sZXZlbC1pZD00MjAwMWZcclxuYT1ydHBtYXA6MTA1IHJ0eC85MDAwMFxyXG5hPWZtdHA6MTA1IGFwdD0xMDRcclxuYT1ydHBtYXA6MTA2IEgyNjQvOTAwMDBcclxuYT1ydGNwLWZiOjEwNiBnb29nLXJlbWJcclxuYT1ydGNwLWZiOjEwNiB0cmFuc3BvcnQtY2NcclxuYT1ydGNwLWZiOjEwNiBjY20gZmlyXHJcbmE9cnRjcC1mYjoxMDYgbmFja1xyXG5hPXJ0Y3AtZmI6MTA2IG5hY2sgcGxpXHJcbmE9Zm10cDoxMDYgbGV2ZWwtYXN5bW1ldHJ5LWFsbG93ZWQ9MTtwYWNrZXRpemF0aW9uLW1vZGU9MTtwcm9maWxlLWxldmVsLWlkPTQyZTAxZlxyXG5hPXJ0cG1hcDoxMDcgcnR4LzkwMDAwXHJcbmE9Zm10cDoxMDcgYXB0PTEwNlxyXG5hPXJ0cG1hcDoxMDggSDI2NC85MDAwMFxyXG5hPXJ0Y3AtZmI6MTA4IGdvb2ctcmVtYlxyXG5hPXJ0Y3AtZmI6MTA4IHRyYW5zcG9ydC1jY1xyXG5hPXJ0Y3AtZmI6MTA4IGNjbSBmaXJcclxuYT1ydGNwLWZiOjEwOCBuYWNrXHJcbmE9cnRjcC1mYjoxMDggbmFjayBwbGlcclxuYT1mbXRwOjEwOCBsZXZlbC1hc3ltbWV0cnktYWxsb3dlZD0xO3BhY2tldGl6YXRpb24tbW9kZT0wO3Byb2ZpbGUtbGV2ZWwtaWQ9NDJlMDFmXHJcbmE9cnRwbWFwOjEwOSBydHgvOTAwMDBcclxuYT1mbXRwOjEwOSBhcHQ9MTA4XHJcbmE9cnRwbWFwOjEyNyBIMjY0LzkwMDAwXHJcbmE9cnRjcC1mYjoxMjcgZ29vZy1yZW1iXHJcbmE9cnRjcC1mYjoxMjcgdHJhbnNwb3J0LWNjXHJcbmE9cnRjcC1mYjoxMjcgY2NtIGZpclxyXG5hPXJ0Y3AtZmI6MTI3IG5hY2tcclxuYT1ydGNwLWZiOjEyNyBuYWNrIHBsaVxyXG5hPWZtdHA6MTI3IGxldmVsLWFzeW1tZXRyeS1hbGxvd2VkPTE7cGFja2V0aXphdGlvbi1tb2RlPTE7cHJvZmlsZS1sZXZlbC1pZD00ZDAwMWZcclxuYT1ydHBtYXA6MTI1IHJ0eC85MDAwMFxyXG5hPWZtdHA6MTI1IGFwdD0xMjdcclxuYT1ydHBtYXA6MzkgSDI2NC85MDAwMFxyXG5hPXJ0Y3AtZmI6MzkgZ29vZy1yZW1iXHJcbmE9cnRjcC1mYjozOSB0cmFuc3BvcnQtY2NcclxuYT1ydGNwLWZiOjM5IGNjbSBmaXJcclxuYT1ydGNwLWZiOjM5IG5hY2tcclxuYT1ydGNwLWZiOjM5IG5hY2sgcGxpXHJcbmE9Zm10cDozOSBsZXZlbC1hc3ltbWV0cnktYWxsb3dlZD0xO3BhY2tldGl6YXRpb24tbW9kZT0wO3Byb2ZpbGUtbGV2ZWwtaWQ9NGQwMDFmXHJcbmE9cnRwbWFwOjQwIHJ0eC85MDAwMFxyXG5hPWZtdHA6NDAgYXB0PTM5XHJcbmE9cnRwbWFwOjQ1IEFWMS85MDAwMFxyXG5hPXJ0Y3AtZmI6NDUgZ29vZy1yZW1iXHJcbmE9cnRjcC1mYjo0NSB0cmFuc3BvcnQtY2NcclxuYT1ydGNwLWZiOjQ1IGNjbSBmaXJcclxuYT1ydGNwLWZiOjQ1IG5hY2tcclxuYT1ydGNwLWZiOjQ1IG5hY2sgcGxpXHJcbmE9cnRwbWFwOjQ2IHJ0eC85MDAwMFxyXG5hPWZtdHA6NDYgYXB0PTQ1XHJcbmE9cnRwbWFwOjk4IFZQOS85MDAwMFxyXG5hPXJ0Y3AtZmI6OTggZ29vZy1yZW1iXHJcbmE9cnRjcC1mYjo5OCB0cmFuc3BvcnQtY2NcclxuYT1ydGNwLWZiOjk4IGNjbSBmaXJcclxuYT1ydGNwLWZiOjk4IG5hY2tcclxuYT1ydGNwLWZiOjk4IG5hY2sgcGxpXHJcbmE9Zm10cDo5OCBwcm9maWxlLWlkPTBcclxuYT1ydHBtYXA6OTkgcnR4LzkwMDAwXHJcbmE9Zm10cDo5OSBhcHQ9OThcclxuYT1ydHBtYXA6MTAwIFZQOS85MDAwMFxyXG5hPXJ0Y3AtZmI6MTAwIGdvb2ctcmVtYlxyXG5hPXJ0Y3AtZmI6MTAwIHRyYW5zcG9ydC1jY1xyXG5hPXJ0Y3AtZmI6MTAwIGNjbSBmaXJcclxuYT1ydGNwLWZiOjEwMCBuYWNrXHJcbmE9cnRjcC1mYjoxMDAgbmFjayBwbGlcclxuYT1mbXRwOjEwMCBwcm9maWxlLWlkPTJcclxuYT1ydHBtYXA6MTAxIHJ0eC85MDAwMFxyXG5hPWZtdHA6MTAxIGFwdD0xMDBcclxuYT1ydHBtYXA6MTEyIEgyNjQvOTAwMDBcclxuYT1ydGNwLWZiOjExMiBnb29nLXJlbWJcclxuYT1ydGNwLWZiOjExMiB0cmFuc3BvcnQtY2NcclxuYT1ydGNwLWZiOjExMiBjY20gZmlyXHJcbmE9cnRjcC1mYjoxMTIgbmFja1xyXG5hPXJ0Y3AtZmI6MTEyIG5hY2sgcGxpXHJcbmE9Zm10cDoxMTIgbGV2ZWwtYXN5bW1ldHJ5LWFsbG93ZWQ9MTtwYWNrZXRpemF0aW9uLW1vZGU9MTtwcm9maWxlLWxldmVsLWlkPTY0MDAxZlxyXG5hPXJ0cG1hcDoxMTMgcnR4LzkwMDAwXHJcbmE9Zm10cDoxMTMgYXB0PTExMlxyXG5hPXJ0cG1hcDoxMTYgcmVkLzkwMDAwXHJcbmE9cnRwbWFwOjExNyBydHgvOTAwMDBcclxuYT1mbXRwOjExNyBhcHQ9MTE2XHJcbmE9cnRwbWFwOjExOCB1bHBmZWMvOTAwMDBcclxuYT1zc3JjLWdyb3VwOkZJRCA3OTk5MTg0MSAzMTg1Mjg0Njg0XHJcbmE9c3NyYzo3OTk5MTg0MSBjbmFtZTowdWFxZlFMMW03VUN1TGVHXHJcbmE9c3NyYzo3OTk5MTg0MSBtc2lkOi0gZjZmZGQwNTAtZmFlYS00YjBlLWI3NTgtMjM1YTAyOTljM2Q4XHJcbmE9c3NyYzozMTg1Mjg0Njg0IGNuYW1lOjB1YXFmUUwxbTdVQ3VMZUdcclxuYT1zc3JjOjMxODUyODQ2ODQgbXNpZDotIGY2ZmRkMDUwLWZhZWEtNGIwZS1iNzU4LTIzNWEwMjk5YzNkOFxyXG5tPWF1ZGlvIDE1OTMwIFVEUC9UTFMvUlRQL1NBVlBGIDExMSA2MyA5IDAgOCAxMyAxMTAgMTI2XHJcbmM9SU4gSVA0IDE5NC43OC4xNC43NFxyXG5hPXJ0Y3A6OSBJTiBJUDQgMC4wLjAuMFxyXG5hPWNhbmRpZGF0ZTo0NDYyOTE3NzEgMSB1ZHAgMjExMzkzNzE1MSAxMDcwNjQ4OS0zOWRmLTQxM2ItODczNy0wZTE5N2NhNjY1MzIubG9jYWwgNTE3ODkgdHlwIGhvc3QgZ2VuZXJhdGlvbiAwIG5ldHdvcmstY29zdCA5OTlcclxuYT1jYW5kaWRhdGU6MTM4NDM5NjE3NCAxIHVkcCAxNjc3NzI5NTM1IDE5NC43OC4xNC43NCAxNTkzMCB0eXAgc3JmbHggcmFkZHIgMC4wLjAuMCBycG9ydCAwIGdlbmVyYXRpb24gMCBuZXR3b3JrLWNvc3QgOTk5XHJcbmE9aWNlLXVmcmFnOjBNVjFcclxuYT1pY2UtcHdkOjJzUXc2UXRQZklIZFEweXlmWlFNUGN6U1xyXG5hPWljZS1vcHRpb25zOnRyaWNrbGVcclxuYT1maW5nZXJwcmludDpzaGEtMjU2IDlEOkU0OkJBOjZEOkJDOjQ2OjNCOkMwOkI2OkRCOjgyOkNCOjIyOjNGOkZBOjYxOkI1OkI5OjBDOjcxOkUzOjg4OjZEOjQxOjBBOjMwOkY2OkFEOjI1Ojk5OjUwOjk5XHJcbmE9c2V0dXA6YWN0cGFzc1xyXG5hPW1pZDoxXHJcbmE9ZXh0bWFwOjE0IHVybjppZXRmOnBhcmFtczpydHAtaGRyZXh0OnNzcmMtYXVkaW8tbGV2ZWxcclxuYT1leHRtYXA6MiBodHRwOi8vd3d3LndlYnJ0Yy5vcmcvZXhwZXJpbWVudHMvcnRwLWhkcmV4dC9hYnMtc2VuZC10aW1lXHJcbmE9ZXh0bWFwOjQgaHR0cDovL3d3dy5pZXRmLm9yZy9pZC9kcmFmdC1ob2xtZXItcm1jYXQtdHJhbnNwb3J0LXdpZGUtY2MtZXh0ZW5zaW9ucy0wMVxyXG5hPWV4dG1hcDo5IHVybjppZXRmOnBhcmFtczpydHAtaGRyZXh0OnNkZXM6bWlkXHJcbmE9c2VuZHJlY3ZcclxuYT1tc2lkOi0gZjJkYzdhYWYtMTM0ZS00ZGEzLWJlZWMtNjIzYTFmNjVmYzg5XHJcbmE9cnRjcC1tdXhcclxuYT1ydHBtYXA6MTExIG9wdXMvNDgwMDAvMlxyXG5hPXJ0Y3AtZmI6MTExIHRyYW5zcG9ydC1jY1xyXG5hPWZtdHA6MTExIG1pbnB0aW1lPTEwO3VzZWluYmFuZGZlYz0xXHJcbmE9cnRwbWFwOjYzIHJlZC80ODAwMC8yXHJcbmE9Zm10cDo2MyAxMTEvMTExXHJcbmE9cnRwbWFwOjkgRzcyMi84MDAwXHJcbmE9cnRwbWFwOjAgUENNVS84MDAwXHJcbmE9cnRwbWFwOjggUENNQS84MDAwXHJcbmE9cnRwbWFwOjEzIENOLzgwMDBcclxuYT1ydHBtYXA6MTEwIHRlbGVwaG9uZS1ldmVudC80ODAwMFxyXG5hPXJ0cG1hcDoxMjYgdGVsZXBob25lLWV2ZW50LzgwMDBcclxuYT1zc3JjOjg0MDMzNTIzMyBjbmFtZTowdWFxZlFMMW03VUN1TGVHXHJcbmE9c3NyYzo4NDAzMzUyMzMgbXNpZDotIGYyZGM3YWFmLTEzNGUtNGRhMy1iZWVjLTYyM2ExZjY1ZmM4OVxyXG4ifQ=="

    offer = RTCSessionDescription(sdp=sdp_offer, type="offer")
    await pc.setRemoteDescription(offer)
    answer = await pc.createAnswer()
    await pc.setLocalDescription(answer)

    print("Answer SDP:")
    print(pc.localDescription.sdp)

    # Wait for connection to be established
    await asyncio.sleep(30)

    if video_player:
        video_player.stop()
    if audio_player:
        audio_player.stop()

async def main():
    audio_path = "output.ogg"
    video_path = "output.h264"
    pc = RTCPeerConnection()

    try:
        await run(pc, None, audio_path, video_path)
    except Exception as e:
        print(e)
    finally:
        await pc.close()

if __name__ == "__main__":
    asyncio.run(main())
